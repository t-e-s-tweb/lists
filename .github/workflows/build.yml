name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.1
      with:
       repository: 'XTLS/Xray-core'
       ref: 'main'
    #   fetch-depth: 0
   # - name: commit
   #   run: git checkout 98a72b6fb49bcc403c4cae1ff529b9def43e6ad8
    - name: Set up Go
      uses: actions/setup-go@v5.5.0
      with:
        go-version: '1.24'
        cache: true
        check-latest: true
    - name: Setup Zig
      uses: mlugg/setup-zig@v2
      with:
       version: 0.14.1
       
    - name: Get project dependencies
      run: go mod download
        
    - name: build for android arm64
      run: GOOS=android GOARCH=arm64 CC="zig cc -target aarch64-linux-android" CXX="zig c++ -target aarch64-linux-android" go build -o xandroid64 -trimpath -buildvcs=false -ldflags "-s -w -buildid=" ./main
    - name: build for winamd64
      run: env CGO_ENABLED="0" GOOS=windows GOARCH=amd64 CC="zig cc -target x86_64-windows-gnu" CXX="zig c++ -target x86_64-windows-gnu" go build -o xadmwin64.exe -trimpath -buildvcs=false -ldflags "-s -w -buildid="  ./main
    
    - name: build
      run: |
          curl -LJo ./get.sh https://raw.githubusercontent.com/t-e-s-tweb/lists/xx/get.sh
          chmod +x get.sh
          ./get.sh
  #  - name: build for arm64
  #   run: env CGO_ENABLED="0" GOOS=linux GOARCH=arm64 CC="zig cc -target aarch64-linux-musl" CXX="zig c++ -target aarch64-linux-musl" go build -o sbarm -trimpath -ldflags "-s -w -buildid=" -tags with_utls,with_quic,with_wireguard,with_utls,with_gvisor,staticOpenssl,staticZlib,staticLibevent ./cmd/sing-box
    

    - name: build for amd64
      run: env CGO_ENABLED="0" GOOS=linux GOARCH=amd64 CC="zig cc -target x86_64-linux-musl" CXX="zig c++ -target x86_64-linux-musl" go build -o xadm64 -trimpath -ldflags "-s -w -buildid="  ./main
    
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./xadm64*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
 
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./xandroid*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./xadmwin*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
