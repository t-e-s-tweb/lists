name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.1
      with:
       repository: 'SagerNet/sing-box'
       ref: 'main'
      
    - name: Set up Go
      uses: actions/setup-go@v5.0.0
      with:
        go-version: '1.21.6'
        cache: true
    
    - name: Setup Zig
      uses: korandoru/setup-zig@v1
      with:
       zig-version: master
    - name: Install dependencies
      run: |
          go get -u go.uber.org/automaxprocs
          go get github.com/KimMachineGun/automemlimit@latest 
    - name: Replace Text in version.go
      run: |
        old_text="unknown"
        new_text="this is the bestest version of them all"
        find . -type f -name "version.go" -exec sed -i "s/$old_text/$new_text/g" {} +

    - name: Modify Imports in main.go
      run: |
        sed -i '/^import/ { N; N; N; s/\(.*\)/&\n\t"github.com\/KimMachineGun\/automemlimit\/memlimit"\n\t_ "go.uber.org\/automaxprocs"/; }' cmd/sing-box/main.go
    - name: Add init function to main.go
      run: |
        sed -i '/import (/ {
            :a; N; /\n)/!ba;
            s/)\(.*\)/)\1\
            \
            func init() {\
                memlimit.SetGoMemLimitWithEnv();\
            }/
        }' cmd/sing-box/main.go
    - name: build for arm64
      run: env CGO_ENABLED="0" GOOS=linux GOARCH=arm64 CC="zig cc -target aarch64-linux-musl" CXX="zig c++ -target aarch64-linux-musl" go build -o sbarm -trimpath -ldflags "-s -w -buildid=" -tags with_utls,with_quic,with_wireguard,with_utls,with_gvisor,staticOpenssl,staticZlib,staticLibevent ./cmd/sing-box

    - name: build for amd64
      run: env CGO_ENABLED="0" GOOS=linux GOARCH=amd64 CC="zig cc -target x86_64-linux-musl" CXX="zig c++ -target x86_64-linux-musl" go build -o sb -trimpath -ldflags "-s -w -buildid=" -tags with_utls,with_quic,with_wireguard,with_utls,with_gvisor,staticOpenssl,staticZlib,staticLibevent ./cmd/sing-box

    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./sb*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
