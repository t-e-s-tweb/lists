name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.1
      with:
       repository: 'cloudflare/cloudflared'
       ref: 'master'
      
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.26.0-rc.3'
        cache: true
        check-latest: true
    - name: Setup Zig
      uses: mlugg/setup-zig@v2
      with:
       version: master
    - name: Install dependencies
      run: |
          go get github.com/KimMachineGun/automemlimit@latest 
          go mod vendor


    - name: Update main.go
      run: |
        sed -i '/^import/ { N; N; N; s/\(.*\)/&\n\t"github.com\/KimMachineGun\/automemlimit\/memlimit"/; }' cmd/cloudflared/main.go
        sed -i '/import (/ { :a; N; /\n)/!ba; s/)\(.*\)/)\1\n\nfunc init() {\n    memlimit.SetGoMemLimitWithEnv();\n}/ }' cmd/cloudflared/main.go

 #   - name: build for arm64
  #    run: env CGO_ENABLED="0" GOOS=linux GOARCH=arm64 CC="zig cc -target aarch64-linux-musl" CXX="zig c++ -target aarch64-linux-musl" go build -mod=mod -o cloudyarm64 -trimpath -ldflags "-s -w -buildid=" ./cmd/cloudflared

    - name: build for amd64
      run: |
        export GOEXPERIMENT="runtimefreegc,sizespecializedmalloc,greenteagc,jsonv2,newinliner,heapminimum512kib"
        export CGO_CFLAGS="-O2 -g"
        export CGO_CXXFLAGS="-O2 -g"
        export CGO_LDFLAGS="-Wl,-z,max-page-size=0x4000 -Wl,-z,common-page-size=0x4000 -Wl,-z,separate-loadable-segments"

        env CGO_ENABLED="1" GOOS=linux GOARCH=amd64 go build -mod=mod -o cloudy -trimpath -gcflags="all=-l=4" -buildvcs=false -ldflags "-s -w -buildid=" ./cmd/cloudflared

    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./cloudy*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
