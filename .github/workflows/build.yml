name: Build and Release

on:
  workflow_dispatch:
jobs:
  ubuntu-build:
    runs-on: ubuntu-latest
    container: docker.io/ubuntu:18.04
    steps:
      - name: Get project dependencies
        run: |
          apt update
          apt install -y ca-certificates git

      - name: get code
        run: |
          git clone https://github.com/SagerNet/sing-box
          cp sing-box/* ./
          rm -rf sing-box

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.20"
          check-latest: true

      - name: build
        run: |
          go build -v -trimpath -tags with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_reality_server,with_acme -o build_assets/helloworld -ldflags "-X \"github.com/sagernet/sing-box/constant.Version=$VERSION\" -s -w -buildid=" ./cmd/sing-box

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.PAT }}
          file: ./build_assets/helloworld
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true