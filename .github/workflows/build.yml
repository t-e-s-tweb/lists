name: Build and Release

on:
  workflow_dispatch:
    inputs:
      merge_prs:
        description: 'Comma-separated PR numbers to merge (e.g., "1,2,3" or "0" for none)'
        required: false
        default: ''
        type: string
      fetch_branch_from_other:
        description: 'Enter "username/repo branch" to fetch & merge, or 0 for none'
        required: false
        default: '0'
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.1
      with:
        repository: 'XTLS/Xray-core'
        ref: 'main'
        fetch-depth: 0

    - name: Fetch and squash-merge PRs (auto-resolve theirs)
      shell: bash
      run: |
          set -e
          set -o pipefail

          echo "Merging PRs: ${{ github.event.inputs.merge_prs }}"
          IFS=',' read -ra PR_LIST <<< "${{ github.event.inputs.merge_prs }}"

          for PR_NUM in "${PR_LIST[@]}"; do
            echo "============================================"
            echo "Fetching PR #$PR_NUM..."
            git fetch origin pull/$PR_NUM/head:pr-$PR_NUM

            echo "Squash-merging PR #$PR_NUM (prefer theirs)..."
            if ! git merge --squash pr-$PR_NUM; then
              echo "⚠️ Conflict detected in PR #$PR_NUM — auto-resolving using theirs..."
              for f in $(git diff --name-only --diff-filter=U); do
                echo "  - Taking theirs version of $f"
                git checkout --theirs -- "$f"
                git add "$f"
              done
            fi

            # Stage any remaining unstaged files
            git add -u
            git add .
          done

          echo "Creating final combined commit..."
          git commit -m "Combined squash merge of PRs: ${{ github.event.inputs.merge_prs }} (auto-resolved theirs)"

    - name: Fetch & merge external branch if requested
      if: ${{ inputs.fetch_branch_from_other != '0' && inputs.fetch_branch_from_other != '' }}
      run: |
        set -e
        REPO_BRANCH="${{ inputs.fetch_branch_from_other }}"
        REPO=$(echo "$REPO_BRANCH" | awk '{print $1}')
        BRANCH=$(echo "$REPO_BRANCH" | awk '{print $2}')
        echo "Fetching branch '$BRANCH' from repo '$REPO'..."
        git remote add external https://github.com/$REPO.git
        git fetch external $BRANCH
        git merge -X theirs --no-edit external/$BRANCH
          


    - name: Set up Go
      uses: actions/setup-go@v5.5.0
      with:
          go-version-file: go.mod
          check-latest: true

    - name: Setup Zig
      uses: mlugg/setup-zig@v2
      with:
        version: 0.14.1

    - name: Get project dependencies
      run: |
        go mod download
        

    - name: Build for Android arm64 (with NDK and CGO enabled)
      env:
        CGO_ENABLED: 1
        GOOS: android
        GOARCH: arm64
      run: |
        # Download Android NDK r28b
        wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28b-linux.zip
        unzip android-ndk.zip
        rm android-ndk.zip

        # Setup CC and CXX for arm64 android
        export CC=$(realpath android-ndk-*/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang)
        export CXX=$(realpath android-ndk-*/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++)
        
        GOEXPERIMENT=greenteagc go build -o xandroid64 -trimpath -gcflags="all=-l=4" -buildvcs=false -ldflags "-s -w -buildid=" -v ./main

    - name: Build for Windows amd64 (non-console)
      env:
        CGO_ENABLED: 0
        GOOS: windows
        GOARCH: amd64
      run: |
        GOEXPERIMENT=greenteagc go build -o xadmwin64.exe -trimpath -gcflags="all=-l=4" -buildvcs=false -ldflags="-H windowsgui -s -w -buildid=" -v ./main

    - name: Run custom build script
      run: |
        curl -LJo ./get.sh https://raw.githubusercontent.com/t-e-s-tweb/lists/xx/get.sh
        chmod +x get.sh
        ./get.sh

    - name: Build for Linux amd64 (CGO disabled)
      env:
        CGO_ENABLED: 0
        GOOS: linux
        GOARCH: amd64
      run: |
        GOEXPERIMENT=greenteagc go build -o xadm64 -trimpath -gcflags="all=-l=4" -buildvcs=false -ldflags "-s -w -buildid=" -v ./main

    # # Alternative Linux amd64 build with Zig (commented out)
    # - name: Build for Linux amd64 (zig)
    #   env:
    #     CGO_ENABLED: 0
    #     GOOS: linux
    #     GOARCH: amd64
    #   run: |
    #     GOOS=linux GOARCH=amd64 CC="zig cc -target x86_64-linux-musl" CXX="zig c++ -target x86_64-linux-musl" \
    #       go build -o xadm64 -trimpath -ldflags "-s -w -buildid=" ./main

    - name: Upload Android binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./xandroid64*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true

    - name: Upload Windows binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./xadmwin64*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true

    - name: Upload Linux binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./xadm64*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true
