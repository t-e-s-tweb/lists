name: Build and Release

on:
  workflow_dispatch:
    inputs:
      pr_count:
        description: 'Number of PRs to merge (0â€“4)'
        required: true
        default: '0'
        type: choice
        options:
          - '0'
          - '1'
          - '2'
          - '3'
          - '4'

      pr1:
        description: 'PR #1 to merge (if any)'
        required: false
        default: ''

      pr2:
        description: 'PR #2 to merge (if any)'
        required: false
        default: ''

      pr3:
        description: 'PR #3 to merge (if any)'
        required: false
        default: ''

      pr4:
        description: 'PR #4 to merge (if any)'
        required: false
        default: ''

      fetch_branch_from_other:
        description: 'Enter "username/repo branch" to fetch & merge, or 0 for none'
        required: false
        default: '0'
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.1
      with:
        repository: 'XTLS/Xray-core'
        ref: 'main'
        fetch-depth: 0

    - name: Merge PRs based on input
      run: |
       set -e
       git config --global user.name "github-actions[bot]"
       git config --global user.email "github-actions[bot]@users.noreply.github.com"
       COUNT=${{ github.event.inputs.pr_count }}

       if [ "$COUNT" -ge 1 ] && [ -n "${{ github.event.inputs.pr1 }}" ]; then
        echo "Merging PR #${{ github.event.inputs.pr1 }}"
        git fetch origin pull/${{ github.event.inputs.pr1 }}/head:pr1
        git merge --no-edit pr1
       fi
       if [ "$COUNT" -ge 2 ] && [ -n "${{ github.event.inputs.pr2 }}" ]; then
        echo "Merging PR #${{ github.event.inputs.pr2 }}"
        git fetch origin pull/${{ github.event.inputs.pr2 }}/head:pr2
        git merge --no-edit pr2
       fi
       if [ "$COUNT" -ge 3 ] && [ -n "${{ github.event.inputs.pr3 }}" ]; then
        echo "Merging PR #${{ github.event.inputs.pr3 }}"
        git fetch origin pull/${{ github.event.inputs.pr3 }}/head:pr3
        git merge --no-edit pr3
       fi
       if [ "$COUNT" -ge 4 ] && [ -n "${{ github.event.inputs.pr4 }}" ]; then
        echo "Merging PR #${{ github.event.inputs.pr4 }}"
        git fetch origin pull/${{ github.event.inputs.pr4 }}/head:pr4
        git merge --no-edit pr4
       fi

    - name: Fetch & merge external branch if requested
      if: ${{ inputs.fetch_branch_from_other != '0' && inputs.fetch_branch_from_other != '' }}
      run: |
        set -e
        REPO_BRANCH="${{ inputs.fetch_branch_from_other }}"
        REPO=$(echo "$REPO_BRANCH" | awk '{print $1}')
        BRANCH=$(echo "$REPO_BRANCH" | awk '{print $2}')
        echo "Fetching branch '$BRANCH' from repo '$REPO'..."
        git remote add external https://github.com/$REPO.git
        git fetch external $BRANCH
        git merge --no-edit external/$BRANCH
          


    - name: Set up Go
      uses: actions/setup-go@v5.5.0
      with:
          go-version-file: go.mod
          check-latest: true

    - name: Setup Zig
      uses: mlugg/setup-zig@v2
      with:
        version: 0.14.1

    - name: Get project dependencies
      run: |
        go mod download
        

    - name: Build for Android arm64 (with NDK and CGO enabled)
      env:
        CGO_ENABLED: 1
        GOOS: android
        GOARCH: arm64
      run: |
        # Download Android NDK r28b
        wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28b-linux.zip
        unzip android-ndk.zip
        rm android-ndk.zip

        # Setup CC and CXX for arm64 android
        export CC=$(realpath android-ndk-*/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang)
        export CXX=$(realpath android-ndk-*/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++)
        
        GOEXPERIMENT=greenteagc go build -o xandroid64 -trimpath -gcflags="all=-l=4" -buildvcs=false -ldflags "-s -w -buildid=" -v ./main

    - name: Build for Windows amd64 (non-console)
      env:
        CGO_ENABLED: 0
        GOOS: windows
        GOARCH: amd64
      run: |
        GOEXPERIMENT=greenteagc go build -o xadmwin64.exe -trimpath -gcflags="all=-l=4" -buildvcs=false -ldflags="-H windowsgui -s -w -buildid=" -v ./main

    - name: Run custom build script
      run: |
        curl -LJo ./get.sh https://raw.githubusercontent.com/t-e-s-tweb/lists/xx/get.sh
        chmod +x get.sh
        ./get.sh

    - name: Build for Linux amd64 (CGO disabled)
      env:
        CGO_ENABLED: 0
        GOOS: linux
        GOARCH: amd64
      run: |
        GOEXPERIMENT=greenteagc go build -o xadm64 -trimpath -gcflags="all=-l=4" -buildvcs=false -ldflags "-s -w -buildid=" -v ./main

    # # Alternative Linux amd64 build with Zig (commented out)
    # - name: Build for Linux amd64 (zig)
    #   env:
    #     CGO_ENABLED: 0
    #     GOOS: linux
    #     GOARCH: amd64
    #   run: |
    #     GOOS=linux GOARCH=amd64 CC="zig cc -target x86_64-linux-musl" CXX="zig c++ -target x86_64-linux-musl" \
    #       go build -o xadm64 -trimpath -ldflags "-s -w -buildid=" ./main

    - name: Upload Android binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./xandroid64*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true

    - name: Upload Windows binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./xadmwin64*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true

    - name: Upload Linux binaries to release
      uses: svenstaro/upload-release-action@2.7.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./xadm64*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true
